<div class="grid">
	<div class="col-12">
		<div class="card">
            <p-tabView>
                <p-tabPanel>
                <ng-template pTemplate="header">
                    <i class="pi pi-user" style="margin-right: 8px;"></i> Control Estudiantes
                </ng-template>
                <!--<button 
                    pButton 
                    label="Reporte de Credenciales"
                    icon="pi pi-file-pdf"
                    class="p-button-warning"
                    (click)="abrirDialogCredenciales()"
                    style="margin-bottom: 1rem">
                </button>-->
                <div class="card">
                    <p-table [value]="estudiantes$ | async" [paginator]="true" [rows]="5" [tableStyle]="{ 'min-width': '50rem' }">
                    <ng-template pTemplate="header">
                        <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Código</th>
                        <th>Paralelo</th>
                        <th>Acciones</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-estudiante>
                        <tr>
                        <td>{{ estudiante.estudiante_id }}</td>
                        <td>{{ estudiante.nombre }}</td>
                        <td>{{ estudiante.apellido }}</td>
                        <td>{{ estudiante.codigo }}</td>
                        <td>{{ estudiante.paralelo }}</td>
                        <td>
                            <button 
                                pButton 
                                class="p-button-rounded p-button-warning p-button-outlined" 
                                icon="pi pi-refresh" 
                                pTooltip="Resetear contraseña"
                                tooltipPosition="top"
                                (click)="confirmarReset(estudiante)"
                                style="margin-right: 0.5rem">
                            </button>
                            <button 
                                pButton 
                                class="p-button-rounded p-button-info p-button-outlined" 
                                icon="pi pi-pencil"
                                pTooltip="Editar estudiante"
                                tooltipPosition="top" 
                                (click)="abrirDialogoEditar(estudiante)" 
                                style="margin-right: 0.5rem">
                            </button>
                            <button 
                                pButton 
                                class="p-button-rounded p-button-danger p-button-outlined"  
                                icon="pi pi-trash" 
                                pTooltip="Eliminar estudiante"
                                tooltipPosition="top"
                                (click)="confirmarEliminar(estudiante)">
                            </button>
                        </td>
                        </tr>
                    </ng-template>
                    </p-table>
                </div>
                </p-tabPanel>
                <p-toast></p-toast>

                <p-dialog 
                header="Generar Reporte de Credenciales" 
                [(visible)]="dialogCredenciales" 
                [modal]="true" 
                [style]="{ width: '350px' }"
                [closable]="false">

                <div class="p-fluid">
                    <label class="mb-2">Seleccione un paralelo</label>
                    <p-dropdown 
                        [options]="paralelos"
                        [(ngModel)]="paraleloSeleccionado"
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Paralelo"
                        [appendTo]="'body'">
                    </p-dropdown>
                </div>

                <ng-template pTemplate="footer">
                    <button 
                    pButton 
                    label="Cancelar" 
                    class="p-button-text"
                    (click)="dialogCredenciales = false">
                    </button>

                    <button 
                    pButton 
                    label="Generar"
                    class="p-button-success"
                    [disabled]="!paraleloSeleccionado"
                    (click)="generarReporteCredenciales()">
                    </button>
                </ng-template>
                </p-dialog>

                <p-dialog 
                    header="Contraseña Temporal Generada"
                    [(visible)]="dialogResetVisible"
                    [modal]="true"
                    [style]="{ width: '400px' }"
                    [closable]="false"
                >

                    <div class="p-fluid">

                        <p><strong>Estudiante:</strong> {{ tempNombre }}</p>
                        <p><strong>Paralelo:</strong> {{ tempParalelo }}</p>

                        <div class="field mt-3">
                            <label>Nueva contraseña temporal:</label>
                            <div class="p-inputgroup">
                                <input pInputText [value]="tempPassword" readonly>
                                <button
                                    type="button"
                                    pButton
                                    icon="pi pi-copy"
                                    class="p-button-outlined"
                                    (click)="copiarTempPassword()"
                                ></button>
                            </div>
                        </div>

                        <small class="text-600 mt-2 block">
                            Esta contraseña temporal debe entregarse al estudiante para que pueda iniciar sesión. 
                            Se le pedirá cambiarla inmediatamente.
                        </small>

                    </div>

                    <ng-template pTemplate="footer">
                        <button 
                            pButton 
                            label="Cerrar"
                            class="p-button-success"
                            (click)="dialogResetVisible = false"
                        ></button>
                    </ng-template>

                </p-dialog>

                <p-confirmDialog 
                    header="Confirmar Restablecimiento" 
                    icon="pi pi-exclamation-triangle" 
                    key="confirmarReset"
                    acceptButtonStyleClass="p-button-warning"
                    rejectButtonStyleClass="p-button-secondary">
                </p-confirmDialog>


                <p-dialog 
                    header="Editar Estudiante" 
                    [(visible)]="dialogVisible" 
                    [modal]="true" 
                    [style]="{ width: '450px' }" 
                    [closable]="false" 
                    [dismissableMask]="true"
                    [breakpoints]="{ '960px': '90vw' }">

                    <form [formGroup]="editForm">
                        <div class="p-fluid">

                        <div class="field">
                            <label>Nombre</label>
                            <input pInputText formControlName="nombre" />
                            <small class="p-error" *ngIf="editForm.get('nombre')?.invalid && editForm.get('nombre')?.touched">
                            El nombre es obligatorio.
                            </small>
                        </div>

                        <div class="field">
                            <label>Apellido</label>
                            <input pInputText formControlName="apellido" />
                            <small class="p-error" *ngIf="editForm.get('apellido')?.invalid && editForm.get('apellido')?.touched">
                            El apellido es obligatorio.
                            </small>
                        </div>

                        <div class="field">
                            <label>Código</label>
                            <input pInputText formControlName="codigo" />
                            <small class="p-error" *ngIf="editForm.get('codigo')?.invalid && editForm.get('codigo')?.touched">
                            El código es obligatorio.
                            </small>
                        </div>

                        <div class="field">
                            <label>Paralelo</label>
                            <p-dropdown 
                            [options]="paralelos"
                            formControlName="paralelo"
                            optionLabel="label"
                            optionValue="value"
                            placeholder="Seleccione un paralelo"
                            [appendTo]="'body'">
                            </p-dropdown>
                            <small class="p-error" *ngIf="editForm.get('paralelo')?.invalid && editForm.get('paralelo')?.touched">
                            El paralelo es obligatorio.
                            </small>
                        </div>

                        </div>
                    </form>

                    <ng-template pTemplate="footer">
                        <button 
                        pButton 
                        icon="pi pi-times" 
                        label="Cancelar" 
                        class="p-button-danger" 
                        (click)="dialogVisible = false">
                        </button>
                        <button 
                        pButton 
                        icon="pi pi-check" 
                        class="p-button-success" 
                        label="Guardar" 
                        (click)="guardarCambios()" 
                        [disabled]="editForm.invalid">
                        </button>
                    </ng-template>
                </p-dialog>
                <p-confirmDialog 
                    header="Confirmar Eliminación" 
                    icon="pi pi-exclamation-triangle" 
                    message="¿Estás seguro de que deseas eliminar este estudiante?" 
                    acceptLabel="Sí" 
                    rejectLabel="No"
                    key="confirmarEliminar"
                    acceptButtonStyleClass="p-button-danger"
                    rejectButtonStyleClass="p-button-secondary">
                </p-confirmDialog>

                <p-tabPanel>
                    <ng-template pTemplate="header">
                        <i class="pi pi-plus" style="margin-right: 8px;"></i> Registrar Estudiante
                    </ng-template>

                    <div style="border-radius:56px; padding:0.3rem; background: linear-gradient(180deg, var(--green-400) 10%, rgba(33, 150, 243, 0) 30%);">
                        <div class="w-full surface-card py-8 px-5 sm:px-8" style="border-radius:53px">
                        
                        <div class="text-center mb-5">
                            <div class="text-900 text-3xl font-medium mb-3">REGISTRO DE ESTUDIANTE</div>
                            <span class="text-600 font-medium">Completa los datos requeridos</span>
                        </div>

                        <div class="flex justify-content-center">
                            <form [formGroup]="registerForm" (ngSubmit)="onRegister()" class="w-full md:w-30rem">

                            <!-- Campo: Nombre -->
                            <div class="mb-4">
                                <label for="nombre" class="block text-900 text-xl font-medium mb-2">Nombre</label>
                                <input id="nombre" type="text" placeholder="Nombre" formControlName="nombre" pInputText class="w-full" style="padding:1rem" />
                                <div *ngIf="registerForm.get('nombre').invalid && registerForm.get('nombre').touched" class="text-red-500">
                                <ng-container *ngIf="registerForm.get('nombre').errors?.['required']">
                                    El nombre es obligatorio.
                                </ng-container>
                                <ng-container *ngIf="registerForm.get('nombre').errors?.['pattern']">
                                    El nombre solo debe contener letras.
                                </ng-container>
                                </div>
                            </div>

                            <!-- Campo: Apellido -->
                            <div class="mb-4">
                                <label for="apellido" class="block text-900 text-xl font-medium mb-2">Apellido</label>
                                <input id="apellido" type="text" placeholder="Apellido" formControlName="apellido" pInputText class="w-full" style="padding:1rem" />
                                <div *ngIf="registerForm.get('apellido').invalid && registerForm.get('apellido').touched" class="text-red-500">
                                <ng-container *ngIf="registerForm.get('apellido').errors?.['required']">
                                    El apellido es obligatorio.
                                </ng-container>
                                <ng-container *ngIf="registerForm.get('apellido').errors?.['pattern']">
                                    El apellido solo debe contener letras.
                                </ng-container>
                                </div>
                            </div>

                            <!-- Campo: Código -->
                            <div class="mb-4">
                                <label for="codigo" class="block text-900 text-xl font-medium mb-2">Código</label>
                                <input id="codigo" type="text" placeholder="Código" formControlName="codigo" pInputText class="w-full" style="padding:1rem" />
                                <div *ngIf="registerForm.get('codigo').invalid && registerForm.get('codigo').touched" class="text-red-500">
                                El código es obligatorio.
                                </div>
                            </div>

                            <!-- Campo: Contraseña (autogenerada y editable) -->
                            <div class="mb-4">
                                <label for="contraseña" class="block text-900 font-medium text-xl mb-2">Contraseña</label>

                                <!-- Grupo de entrada con botón -->
                                <div class="p-inputgroup">
                                    <p-password
                                    id="contraseña"
                                    placeholder="Contraseña generada automáticamente y editable"
                                    formControlName="contraseña"
                                    [toggleMask]="true"
                                    styleClass="w-full"
                                    inputStyleClass="p-3 w-full"
                                    feedback="false">
                                    </p-password>

                                    <!-- Botón para regenerar -->
                                    <button
                                    pButton
                                    icon="pi pi-refresh"
                                    type="button"
                                    class="p-button-outlined p-button-sm"
                                    (click)="generarContrasena()"
                                    pTooltip="Regenerar contraseña"
                                    tooltipPosition="top">
                                    </button>
                                </div>

                                <small class="text-500 block mt-2">
                                    La contraseña se genera automáticamente con el nombre, apellido y código, pero puedes modificarla si lo deseas.
                                </small>

                                <div *ngIf="registerForm.get('contraseña').invalid && registerForm.get('contraseña').touched" class="text-red-500 mt-2">
                                    La contraseña debe tener mínimo 6 caracteres.
                                </div>
                            </div>


                            <!-- Campo: Paralelo (como radio buttons) -->
                            <div class="mb-4">
                                <label class="block text-900 text-xl font-medium mb-3 text-center">Paralelo</label>

                                <!-- Contenedor centrado -->
                                <div class="flex justify-content-center" [formGroup]="registerForm">
                                    <div class="flex gap-5">
                                    <div *ngFor="let p of ['A', 'B', 'C', 'D']" class="flex align-items-center">
                                        <p-radioButton 
                                        [inputId]="'paralelo' + p" 
                                        name="paralelo" 
                                        [value]="p" 
                                        formControlName="paralelo" 
                                        class="mr-2">
                                        </p-radioButton>
                                        <label [for]="'paralelo' + p" class="font-semibold text-lg">{{ p }}</label>
                                    </div>
                                    </div>
                                </div>

                                <div *ngIf="registerForm.get('paralelo').invalid && registerForm.get('paralelo').touched" class="text-red-500 mt-2 text-center">
                                    Debes seleccionar un paralelo.
                                </div>
                                </div>


                            <!-- Botón de registrar -->
                            <div class="mt-6">
                                <button pButton pRipple label="Registrar Estudiante" class="p-button-success w-full p-3 text-xl"  type="submit" [disabled]="registerForm.invalid"></button>
                            </div>
                            </form>
                        </div>
                        </div>
                    </div>
                </p-tabPanel>
     
            </p-tabView>               
        </div>
    </div>
</div>
