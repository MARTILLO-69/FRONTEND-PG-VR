<div class="grid">
  <div class="col-12">
    <div class="card">
      <p-toolbar>
        <!-- Secci√≥n izquierda -->
        <div class="p-toolbar-group-left">
          <h4 class="m-0">Gesti√≥n de Preguntas</h4>
        </div>

        <!-- Secci√≥n derecha -->
        <div class="p-toolbar-group-right">
          <button
            pButton
            type="button"
            label="Nueva Pregunta"
            icon="pi pi-plus"
            class="p-button-success"
            (click)="abrirDialogoCrear()"
          ></button>
        </div>
      </p-toolbar>
    </div>

    <!-- üß© Di√°logo de creaci√≥n / edici√≥n -->
    <p-dialog
      [header]="editandoPreguntaId ? 'Editar Pregunta' : 'Nueva Pregunta'"
      [(visible)]="dialogCrearVisible"
      [modal]="true"
      [style]="{ width: '650px' }"
      [closable]="false"
      [dismissableMask]="true"
      [breakpoints]="{ '960px': '90vw' }"
    >
      <form [formGroup]="formularioPregunta">
        <div class="p-fluid">

          <!-- Nivel -->
          <div class="field" *ngIf="!editandoPreguntaId">
            <label>Nivel</label>
            <p-dropdown
              [options]="niveles"
              optionLabel="nombre"
              optionValue="nivel_id"
              formControlName="nivel_id"
              [disabled]="niveles.length === 0"
              [optionDisabled]="esNivelDeshabilitado"
              placeholder="Seleccione un nivel">
            </p-dropdown>
          </div>

          <!-- Actividad -->
          <div class="field" *ngIf="!editandoPreguntaId">
            <label>Actividad</label>
            <p-dropdown
              [options]="actividades"
              optionLabel="nombre"
              optionValue="actividad_id"
              formControlName="actividad_id"
              placeholder="Seleccione una actividad">
            </p-dropdown>
          </div>

          <!-- Categor√≠a (solo Nivel 1) -->
          <div class="field" *ngIf="formularioPregunta.get('nivel_id')?.value === 1">
            <label>Categor√≠a</label>
            <p-dropdown
              formControlName="categoria"
              [options]="[
                { label: 'C√©lula Animal', value: 'animal' },
                { label: 'C√©lula Vegetal', value: 'vegetal' }
              ]"
              placeholder="Seleccione la categor√≠a">
            </p-dropdown>
          </div>

          <!-- Enunciado -->
          <div class="field">
            <label>Enunciado</label>
            <textarea
              id="enunciado"
              pInputTextarea
              formControlName="enunciado"
              [autoResize]="true"
              rows="4"
              class="w-full"
              [placeholder]="
                formularioPregunta.get('tipo_pregunta')?.value === 'definicion'
                  ? 'Ejemplo: La c√©lula ________ realiza ________ procesos de ________.'
                  : 'Escriba el enunciado de la pregunta...'
              ">
            </textarea>

            <!-- üß† Vista previa de huecos -->
            <div *ngIf="mostrarVistaPrevia" class="mt-2 p-2 border-round surface-border bg-gray-50">
              <strong>Vista previa:</strong>
              <div class="mt-2 p-2 border-round surface-border bg-gray-50">
                <p class="mt-1" [innerHTML]="vistaPrevia"></p>
              </div>
            </div>
          </div>

          <!-- Tipo -->
          <div class="field">
            <label>Tipo de Pregunta</label>
            <p-dropdown
              [options]="tiposPregunta"
              formControlName="tipo_pregunta"
              [optionDisabled]="esTipoNivel2Deshabilitado"
              placeholder="Seleccione tipo">
            </p-dropdown>
          </div>

          <!-- Dificultad -->
          <div class="field">
            <label>Dificultad</label>
            <p-dropdown
              [options]="nivelesDificultad"
              formControlName="nivel_dificultad"
              placeholder="Seleccione nivel">
            </p-dropdown>

            <!-- Descripciones -->
            <small *ngIf="formularioPregunta.get('nivel_dificultad')?.value === 'B'" class="block text-muted mt-1">
              üî∞ En dificultad <b>Baja</b>: respuestas en <b>orden aleatorio</b>.
            </small>
            <small *ngIf="formularioPregunta.get('nivel_dificultad')?.value === 'M'" class="block text-muted mt-1">
              ‚öôÔ∏è En dificultad <b>Media</b>: <b>semi-aleatorias</b>.
            </small>
            <small *ngIf="formularioPregunta.get('nivel_dificultad')?.value === 'A'" class="block text-muted mt-1">
              üîí En dificultad <b>Alta</b>: <b>mantiene el orden</b> indicado por el docente.
            </small>
          </div>

          <!-- ‚úÖ Requiere orden -->
          <div class="field-checkbox mb-3">
            <p-checkbox
              binary="true"
              formControlName="requiere_orden"
              label="Requiere orden de respuestas">
            </p-checkbox>
          </div>

          <!-- Bloque de respuestas -->
          <div *ngIf="formularioPregunta.get('tipo_pregunta')?.value as tipo">
            <div class="mt-2 mb-2">
              <p *ngIf="tipo === 'definicion'" class="text-sm text-muted">
                ‚û§ 6 opciones, <b>2 o 3 correctas</b>.
              </p>
              <p *ngIf="tipo === 'falso_verdadero'" class="text-sm text-muted">
                ‚û§ 2 opciones, <b>1 correcta</b>.
              </p>
              <p *ngIf="tipo === 'acertijo'" class="text-sm text-muted">
                ‚û§ 9 opciones, <b>3 correctas</b>.
              </p>
            </div>

            <!-- Respuestas -->
            <div formArrayName="respuestas" class="grid">
              <div *ngFor="let respuesta of respuestas.controls; let i = index"
                  [formGroupName]="i"
                  class="col-12 md:col-6 flex align-items-center mb-2">

                <div class="flex align-items-center w-full">
                  <input
                    pInputText
                    formControlName="texto"
                    placeholder="Respuesta {{ i + 1 }}"
                    class="w-full mr-2"
                  />

                  <div class="flex align-items-center gap-1">
                    <p-checkbox
                      binary="true"
                      formControlName="es_correcta"
                      inputId="correcta_{{ i }}"
                      (onChange)="actualizarOrdenRespuesta(i, $event)">
                    </p-checkbox>

                    <!-- üß© Etiqueta visual del orden -->
                    <span *ngIf="respuesta.get('orden')?.value"
                          class="text-xs text-primary font-bold ml-1">
                      #{{ respuesta.get('orden')?.value }}
                    </span>
                  </div>
                </div>
              </div>
            </div>


            <!-- Validaci√≥n -->
            <small *ngIf="!validarRespuestas()" class="block text-red-500 mt-1">
              ‚ö†Ô∏è Configuraci√≥n incorrecta o n√∫mero de respuestas inv√°lido.
            </small>
          </div>
        </div>
      </form>

      <!-- Footer -->
      <ng-template pTemplate="footer">
        <button
          pButton
          label="Cancelar"
          icon="pi pi-times"
          class="p-button-danger"
          (click)="cerrarDialogo()">
        </button>
        <button
          pButton
          label="Guardar"
          icon="pi pi-check"
          class="p-button-success"
          (click)="guardarPregunta()"
          [disabled]="formularioPregunta.invalid">
        </button>
      </ng-template>
    </p-dialog>


    <!-- Toast general -->
    <p-toast></p-toast>

    <!-- ==================== TABLAS ==================== -->

    <!-- üü¢ NIVEL 1 -->
    <div class="card mb-4">
      <h5 class="text-black mb-3">Nivel 1</h5>
      <div class="flex align-items-center justify-content-between mb-3">
        <div class="text-sm text-gray-700">
          <strong>C√©lula Animal:</strong>
          <span [ngClass]="{ 'text-green-600': nivel1Animal < 20, 'text-red-600': nivel1Animal >= 20 }">
            {{ nivel1Animal }}/20
          </span>
          &nbsp; | &nbsp;
          <strong>C√©lula Vegetal:</strong>
          <span [ngClass]="{ 'text-green-600': nivel1Vegetal < 20, 'text-red-600': nivel1Vegetal >= 20 }">
            {{ nivel1Vegetal }}/20
          </span>
        </div>

        <!-- üü¢ Indicador de estado general -->
        <p-tag
          [value]="nivel1Lleno ? 'L√≠mite alcanzado' : 'Espacios disponibles'"
          [severity]="nivel1Lleno ? 'danger' : 'success'">
        </p-tag>
      </div>

      <p-table *ngIf="preguntasNivel1.length"
               [value]="preguntasNivel1"
               [paginator]="true"
               [rows]="5"
               [tableStyle]="{ 'min-width': '60rem' }">

        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Pregunta</th>
            <th>Tipo</th>
            <th>Dificultad</th>
            <th>Orden</th>
            <th>Categor√≠a</th>
            <th>Respuestas</th>
            <th>Acciones</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-pregunta>
          <tr>
            <td>{{ pregunta.pregunta_id }}</td>
            <td>{{ pregunta.enunciado }}</td>
            <td>
              <p-tag
                [value]="
                  pregunta.tipo_pregunta === 'definicion'
                    ? 'Definici√≥n'
                    : pregunta.tipo_pregunta === 'falso_verdadero'
                    ? 'Falso/Verdadero'
                    : 'Acertijo'
                "
                [severity]="
                  pregunta.tipo_pregunta === 'definicion'
                    ? 'info'
                    : pregunta.tipo_pregunta === 'falso_verdadero'
                    ? 'success'
                    : 'warning'
                ">
              </p-tag>
            </td>
            <td>{{ pregunta.nivel_dificultad }}</td>
            <td>
              <p-tag
                [value]="
                  pregunta.nivel_dificultad === 'A'
                    ? 'Secuencial'
                    : pregunta.nivel_dificultad === 'M'
                    ? 'Semi-aleatorio'
                    : 'Aleatorio'
                "
                [severity]="
                  pregunta.nivel_dificultad === 'A'
                    ? 'danger'
                    : pregunta.nivel_dificultad === 'M'
                    ? 'warning'
                    : 'info'
                ">
              </p-tag>
            </td>
            <td>
              <p-tag
                *ngIf="pregunta.categoria"
                [value]="pregunta.categoria === 'animal' ? 'Animal' : 'Vegetal'"
                [severity]="pregunta.categoria === 'animal' ? 'info' : 'success'">
              </p-tag>
            </td>
            <td>
              <div class="flex flex-wrap gap-2">
                <p-tag *ngFor="let r of pregunta.respuestas"
                       [value]="r.texto_respuesta"
                       [severity]="r.es_correcta ? 'success' : 'danger'"
                       [icon]="r.es_correcta ? 'pi pi-check' : 'pi pi-times'"
                       rounded>
                </p-tag>
              </div>
            </td>
            <td>
              <div class="flex align-items-center gap-2">
                <button
                  pButton
                  class="p-button-rounded p-button-info p-button-outlined"
                  icon="pi pi-pencil"
                  (click)="abrirDialogoEditar(pregunta)">
                </button>
                <button
                  pButton
                  class="p-button-rounded p-button-danger p-button-outlined"
                  icon="pi pi-trash"
                  (click)="confirmarEliminar(pregunta)">
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- üîµ NIVEL 2 -->
    <div class="card mb-4">
      <h5 class="text-black mb-3">Nivel 2</h5>
      <div class="flex align-items-center justify-content-between mb-3">
        <div class="text-sm text-gray-700">
          <strong>Falso/Verdadero:</strong>
          <span [ngClass]="{ 'text-green-600': nivel2FalsoVerdadero < 12, 'text-red-600': nivel2FalsoVerdadero >= 12 }">
            {{ nivel2FalsoVerdadero }}/12
          </span>
          &nbsp; | &nbsp;
          <strong>Acertijo:</strong>
          <span [ngClass]="{ 'text-green-600': nivel2Acertijo < 8, 'text-red-600': nivel2Acertijo >= 8 }">
            {{ nivel2Acertijo }}/8
          </span>
        </div>

        <p-tag
          [value]="nivel2Lleno ? 'L√≠mite alcanzado' : 'Espacios disponibles'"
          [severity]="nivel2Lleno ? 'danger' : 'success'">
        </p-tag>
      </div>
      <p-table *ngIf="preguntasNivel2.length"
               [value]="preguntasNivel2"
               [paginator]="true"
               [rows]="5"
               [tableStyle]="{ 'min-width': '60rem' }">

        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Pregunta</th>
            <th>Tipo</th>
            <th>Dificultad</th>
            <th>Orden</th>
            <th>Respuestas</th>
            <th>Acciones</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-pregunta>
          <tr>
            <td>{{ pregunta.pregunta_id }}</td>
            <td>{{ pregunta.enunciado }}</td>
            <td>
              <p-tag
                [value]="
                  pregunta.tipo_pregunta === 'falso_verdadero'
                    ? 'Falso/Verdadero'
                    : 'Acertijo'
                "
                [severity]="
                  pregunta.tipo_pregunta === 'falso_verdadero'
                    ? 'success'
                    : 'warning'
                ">
              </p-tag>
            </td>
            <td>{{ pregunta.nivel_dificultad }}</td>
            <td>
              <p-tag
                [value]="
                  pregunta.nivel_dificultad === 'A'
                    ? 'Secuencial'
                    : pregunta.nivel_dificultad === 'M'
                    ? 'Semi-aleatorio'
                    : 'Aleatorio'
                "
                [severity]="
                  pregunta.nivel_dificultad === 'A'
                    ? 'danger'
                    : pregunta.nivel_dificultad === 'M'
                    ? 'warning'
                    : 'info'
                ">
              </p-tag>
            </td>
            <td>
              <div class="flex flex-wrap gap-2">
                <p-tag *ngFor="let r of pregunta.respuestas"
                       [value]="r.texto_respuesta"
                       [severity]="r.es_correcta ? 'success' : 'danger'"
                       [icon]="r.es_correcta ? 'pi pi-check' : 'pi pi-times'"
                       rounded>
                </p-tag>
              </div>
            </td>
            <td>
              <div class="flex align-items-center gap-2">
                <button pButton class="p-button-rounded p-button-info p-button-outlined" icon="pi pi-pencil" (click)="abrirDialogoEditar(pregunta)"></button>
                <button pButton class="p-button-rounded p-button-danger p-button-outlined" icon="pi pi-trash" (click)="confirmarEliminar(pregunta)"></button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- üî¥ NIVEL 3 -->
    <div class="card mb-4">
      <h5 class="text-black mb-3">Nivel 3</h5>
      <!-- üßÆ Resumen de preguntas Nivel 3 -->
      <div class="flex align-items-center justify-content-between mb-3">
        <div class="text-sm text-gray-700">
          <strong>Acertijos registrados:</strong>
          <span [ngClass]="{ 'text-green-600': nivel3Acertijo < 12, 'text-red-600': nivel3Acertijo >= 12 }">
            {{ nivel3Acertijo }}/12
          </span>
        </div>

        <p-tag
          [value]="nivel3Lleno ? 'L√≠mite alcanzado' : 'Espacios disponibles'"
          [severity]="nivel3Lleno ? 'danger' : 'success'">
        </p-tag>
      </div>

      <p-table *ngIf="preguntasNivel3.length"
               [value]="preguntasNivel3"
               [paginator]="true"
               [rows]="5"
               [tableStyle]="{ 'min-width': '60rem' }">

        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Pregunta</th>
            <th>Tipo</th>
            <th>Dificultad</th>
            <th>Orden</th>
            <th>Respuestas</th>
            <th>Acciones</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-pregunta>
          <tr>
            <td>{{ pregunta.pregunta_id }}</td>
            <td>{{ pregunta.enunciado }}</td>
            <td>
              <p-tag value="Acertijo" severity="warning"></p-tag>
            </td>
            <td>{{ pregunta.nivel_dificultad }}</td>
            <td>
              <p-tag
                [value]="
                  pregunta.nivel_dificultad === 'A'
                    ? 'Secuencial'
                    : pregunta.nivel_dificultad === 'M'
                    ? 'Semi-aleatorio'
                    : 'Aleatorio'
                "
                [severity]="
                  pregunta.nivel_dificultad === 'A'
                    ? 'danger'
                    : pregunta.nivel_dificultad === 'M'
                    ? 'warning'
                    : 'info'
                ">
              </p-tag>
            </td>
            <td>
              <div class="flex flex-wrap gap-2">
                <p-tag *ngFor="let r of pregunta.respuestas"
                       [value]="r.texto_respuesta"
                       [severity]="r.es_correcta ? 'success' : 'danger'"
                       [icon]="r.es_correcta ? 'pi pi-check' : 'pi pi-times'"
                       rounded>
                </p-tag>
              </div>
            </td>
            <td>
              <div class="flex align-items-center gap-2">
                <button pButton class="p-button-rounded p-button-info p-button-outlined" icon="pi pi-pencil" (click)="abrirDialogoEditar(pregunta)"></button>
                <button pButton class="p-button-rounded p-button-danger p-button-outlined" icon="pi pi-trash" (click)="confirmarEliminar(pregunta)"></button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <p-confirmDialog
      key="confirmarEliminar"
      header="Confirmar Eliminaci√≥n"
      icon="pi pi-exclamation-triangle"
      message="¬øEst√°s seguro de que deseas eliminar esta pregunta?"
      acceptLabel="S√≠"
      rejectLabel="No"
      acceptButtonStyleClass="p-button-danger"
      rejectButtonStyleClass="p-button-secondary">
    </p-confirmDialog>
  </div>
</div>
